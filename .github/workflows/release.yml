name: Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ v* æ ‡ç­¾ï¼ˆå¦‚ v2.0.0ï¼‰

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Xcode ç‰ˆæœ¬
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: æ„å»º Release ç‰ˆæœ¬
        run: |
          swift build -c release
          echo "âœ… æ„å»ºå®Œæˆ"

      - name: åˆ›å»º .app åŒ…ç»“æ„
        run: |
          # åˆ›å»º .app ç›®å½•ç»“æ„
          mkdir -p build/ChargingPowerTool.app/Contents/MacOS
          mkdir -p build/ChargingPowerTool.app/Contents/Resources

          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          cp .build/arm64-apple-macosx/release/ChargingPowerTool build/ChargingPowerTool.app/Contents/MacOS/

          # åˆ›å»º Info.plist
          cat > build/ChargingPowerTool.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>ChargingPowerTool</string>
              <key>CFBundleIdentifier</key>
              <string>com.example.ChargingPowerTool</string>
              <key>CFBundleName</key>
              <string>ChargingPowerTool</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>${GITHUB_REF_NAME#v}</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSMinimumSystemVersion</key>
              <string>13.0</string>
              <key>LSUIElement</key>
              <true/>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF

          echo "âœ… .app åŒ…åˆ›å»ºå®Œæˆ"

      - name: æ‰“åŒ… ZIP
        run: |
          cd build
          zip -qry ChargingPowerTool.zip ChargingPowerTool.app
          ls -lh ChargingPowerTool.zip
          echo "âœ… ZIP æ‰“åŒ…å®Œæˆ"

      - name: ç”Ÿæˆ Release Notes
        id: release_notes
        run: |
          # ä»æœ€æ–°çš„ commit æ¶ˆæ¯ä¸­æå–ç‰ˆæœ¬ä¿¡æ¯
          NOTES=$(git log -1 --pretty=format:"%B")

          # å¦‚æœæ²¡æœ‰è¯¦ç»†è¯´æ˜ï¼Œä½¿ç”¨é»˜è®¤æ¨¡æ¿
          if [ -z "$NOTES" ]; then
            NOTES="## ğŸ‰ ChargingPowerTool ${GITHUB_REF_NAME}

          ### ğŸ“¦ ä¸‹è½½
          ä¸‹è½½ \`ChargingPowerTool.zip\` å¹¶è§£å‹ï¼Œæ‹–åŠ¨ \`.app\` åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹å³å¯ä½¿ç”¨ã€‚

          ### ğŸ”§ ç³»ç»Ÿè¦æ±‚
          - macOS 13.0+
          - Apple Silicon (M1/M2/M3) æˆ– Intel å¤„ç†å™¨

          ### ğŸ“ æ›´æ–°å†…å®¹
          è¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) äº†è§£è¯¦ç»†åŠŸèƒ½ã€‚"
          fi

          # ä¿å­˜åˆ°è¾“å‡º
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/ChargingPowerTool.zip
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è¾“å‡ºæˆåŠŸä¿¡æ¯
        run: |
          echo "ğŸ‰ Release ${GITHUB_REF_NAME} å‘å¸ƒæˆåŠŸï¼"
          echo "ğŸ“¦ ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${GITHUB_REF_NAME}"
